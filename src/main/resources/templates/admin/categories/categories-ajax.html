<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout-admin.html}">
<head>
    <meta charset="UTF-8">
    <title>Category Management - AJAX</title>
    <style>
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .error-message {
            display: none;
        }
        .preview-image {
            max-width: 50px;
            max-height: 50px;
            object-fit: cover;
        }
    </style>
</head>
<body>
<section class="row" layout:fragment="content">
    <div class="col mt-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Category Management (AJAX)</h5>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#categoryModal">
                    <i class="fa fa-plus"></i> Add New Category
                </button>
            </div>
            <div class="card-body">

                <!-- Alert Messages -->
                <div id="alert-container"></div>

                <!-- Search Form -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search categories...">
                            <button class="btn btn-outline-primary" type="button" id="searchBtn">
                                <i class="fa fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-secondary float-end" type="button" id="refreshBtn">
                            <i class="fa fa-refresh"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div class="loading" id="loadingIndicator">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading categories...</p>
                </div>

                <!-- Categories Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="categoryTable">
                        <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Category Name</th>
                            <th>Icon</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="categoryTableBody">
                        <!-- Data will be loaded via AJAX -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div class="text-center p-4" id="emptyState" style="display: none;">
                    <i class="fa fa-folder-open fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No categories found</h5>
                    <p class="text-muted">Click "Add New Category" to create your first category.</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Category Modal (Add/Edit) -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalLabel">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="categoryForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="hidden" id="categoryId" name="categoryId">

                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Category Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="categoryName" name="categoryName" required>
                        <div class="invalid-feedback" id="categoryNameError"></div>
                    </div>

                    <div class="mb-3">
                        <label for="icon" class="form-label">Icon</label>
                        <input type="file" class="form-control" id="icon" name="icon" accept="image/*">
                        <div class="invalid-feedback" id="iconError"></div>
                        <div class="mt-2">
                            <img id="iconPreview" src="" alt="Icon Preview" class="preview-image" style="display: none;">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">
                        <span class="spinner-border spinner-border-sm d-none" role="status" id="saveSpinner"></span>
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the category "<span id="deleteCategoryName"></span>"?</p>
                <p class="text-muted">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <span class="spinner-border spinner-border-sm d-none" role="status" id="deleteSpinner"></span>
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Category Modal -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewModalLabel">Category Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>ID:</strong> <span id="viewId"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Name:</strong> <span id="viewName"></span>
                    </div>
                </div>
                <div class="row mt-3" id="viewIconRow" style="display: none;">
                    <div class="col-12">
                        <strong>Icon:</strong><br>
                        <img id="viewIcon" src="" alt="Category Icon" class="img-thumbnail" style="max-width: 200px;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editFromViewBtn">Edit</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let currentCategoryId = null;
    let allCategories = [];

    $(document).ready(function() {
        loadCategories();
        setupEventHandlers();
    });

    // Setup event handlers
    function setupEventHandlers() {
        // Search functionality
        $('#searchBtn').click(function() {
            const searchTerm = $('#searchInput').val().trim();
            filterCategories(searchTerm);
        });

        $('#searchInput').keypress(function(e) {
            if (e.which === 13) { // Enter key
                $('#searchBtn').click();
            }
        });

        // Refresh button
        $('#refreshBtn').click(function() {
            loadCategories();
            $('#searchInput').val('');
        });

        // Category form submission
        $('#categoryForm').submit(function(e) {
            e.preventDefault();
            saveCategory();
        });

        // File input preview
        $('#icon').change(function() {
            previewImage(this);
        });

        // Modal events
        $('#categoryModal').on('hidden.bs.modal', function() {
            resetForm();
        });

        // Delete confirmation
        $('#confirmDeleteBtn').click(function() {
            deleteCategory(currentCategoryId);
        });

        // Edit from view modal
        $('#editFromViewBtn').click(function() {
            $('#viewModal').modal('hide');
            editCategory(currentCategoryId);
        });
    }

    // Load all categories
    function loadCategories() {
        showLoading(true);

        $.ajax({
            url: '/api/category',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    allCategories = response.data;
                    displayCategories(allCategories);
                    showAlert('Categories loaded successfully', 'success', 2000);
                } else {
                    showAlert('Failed to load categories: ' + response.message, 'danger');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading categories:', error);
                showAlert('Error loading categories. Please try again.', 'danger');
            },
            complete: function() {
                showLoading(false);
            }
        });
    }

    // Display categories in table
    function displayCategories(categories) {
        const tbody = $('#categoryTableBody');
        tbody.empty();

        if (categories.length === 0) {
            $('#emptyState').show();
            $('#categoryTable').hide();
            return;
        }

        $('#emptyState').hide();
        $('#categoryTable').show();

        categories.forEach(function(category) {
            const row = `
            <tr>
                <td>${category.categoryId}</td>
                <td>${category.categoryName}</td>
                <td>
                    ${category.icon ?
                `<img src="/uploads/${category.icon}" alt="Icon" class="preview-image">` :
                '<span class="text-muted">No icon</span>'
            }
                </td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="viewCategory(${category.categoryId})" title="View">
                        <i class="fa fa-eye"></i>
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="editCategory(${category.categoryId})" title="Edit">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="showDeleteModal(${category.categoryId}, '${category.categoryName}')" title="Delete">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
            tbody.append(row);
        });
    }

    // Filter categories
    function filterCategories(searchTerm) {
        if (!searchTerm) {
            displayCategories(allCategories);
            return;
        }

        const filtered = allCategories.filter(category =>
            category.categoryName.toLowerCase().includes(searchTerm.toLowerCase())
        );

        displayCategories(filtered);
        showAlert(`Found ${filtered.length} category(ies)`, 'info', 2000);
    }

    // Save category (Add or Update)
    function saveCategory() {
        const form = document.getElementById('categoryForm');
        const formData = new FormData(form);
        const categoryId = $('#categoryId').val();

        // Clear previous errors
        $('.is-invalid').removeClass('is-invalid');
        $('.invalid-feedback').text('');

        const url = categoryId ? '/api/category/updateCategory' : '/api/category/addCategory';
        const method = 'POST';

        if (categoryId) {
            formData.append('categoryId', categoryId);
        }

        // Show loading state
        $('#saveSpinner').removeClass('d-none');
        $('#saveBtn').prop('disabled', true);

        $.ajax({
            url: url,
            method: method,
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    $('#categoryModal').modal('hide');
                    loadCategories();
                    showAlert(response.message, 'success');
                    resetForm();
                } else {
                    showAlert('Failed to save category: ' + response.message, 'danger');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error saving category:', error);

                if (xhr.status === 400) {
                    const errorMsg = xhr.responseText || 'Validation error';
                    if (errorMsg.includes('Category đã tồn tại')) {
                        $('#categoryName').addClass('is-invalid');
                        $('#categoryNameError').text('Category name already exists');
                    } else {
                        showAlert(errorMsg, 'danger');
                    }
                } else {
                    showAlert('Error saving category. Please try again.', 'danger');
                }
            },
            complete: function() {
                $('#saveSpinner').addClass('d-none');
                $('#saveBtn').prop('disabled', false);
            }
        });
    }

    // View category
    function viewCategory(id) {
        $.ajax({
            url: '/api/category/getCategory',
            method: 'POST',
            data: { id: id },
            success: function(response) {
                if (response.success) {
                    const category = response.data;
                    $('#viewId').text(category.categoryId);
                    $('#viewName').text(category.categoryName);

                    if (category.icon) {
                        $('#viewIcon').attr('src', '/uploads/' + category.icon);
                        $('#viewIconRow').show();
                    } else {
                        $('#viewIconRow').hide();
                    }

                    currentCategoryId = id;
                    $('#viewModal').modal('show');
                } else {
                    showAlert('Failed to load category details', 'danger');
                }
            },
            error: function() {
                showAlert('Error loading category details', 'danger');
            }
        });
    }

    // Edit category
    function editCategory(id) {
        $.ajax({
            url: '/api/category/getCategory',
            method: 'POST',
            data: { id: id },
            success: function(response) {
                if (response.success) {
                    const category = response.data;
                    $('#categoryId').val(category.categoryId);
                    $('#categoryName').val(category.categoryName);

                    if (category.icon) {
                        $('#iconPreview').attr('src', '/uploads/' + category.icon).show();
                    }

                    $('#categoryModalLabel').text('Edit Category');
                    currentCategoryId = id;
                    $('#categoryModal').modal('show');
                } else {
                    showAlert('Failed to load category for editing', 'danger');
                }
            },
            error: function() {
                showAlert('Error loading category for editing', 'danger');
            }
        });
    }

    // Show delete modal
    function showDeleteModal(id, name) {
        currentCategoryId = id;
        $('#deleteCategoryName').text(name);
        $('#deleteModal').modal('show');
    }

    // Delete category
    function deleteCategory(id) {
        $('#deleteSpinner').removeClass('d-none');
        $('#confirmDeleteBtn').prop('disabled', true);

        $.ajax({
            url: '/api/category/deleteCategory',
            method: 'DELETE',
            data: { categoryId: id },
            success: function(response) {
                if (response.success) {
                    $('#deleteModal').modal('hide');
                    loadCategories();
                    showAlert('Category deleted successfully', 'success');
                } else {
                    showAlert('Failed to delete category: ' + response.message, 'danger');
                }
            },
            error: function() {
                showAlert('Error deleting category', 'danger');
            },
            complete: function() {
                $('#deleteSpinner').addClass('d-none');
                $('#confirmDeleteBtn').prop('disabled', false);
            }
        });
    }

    // Utility functions
    function showLoading(show) {
        if (show) {
            $('#loadingIndicator').show();
            $('#categoryTable').hide();
            $('#emptyState').hide();
        } else {
            $('#loadingIndicator').hide();
        }
    }

    function showAlert(message, type, autoHide = 0) {
        const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;

        $('#alert-container').html(alertHtml);

        if (autoHide > 0) {
            setTimeout(function() {
                $('#alert-container .alert').alert('close');
            }, autoHide);
        }
    }

    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#iconPreview').attr('src', e.target.result).show();
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function resetForm() {
        $('#categoryForm')[0].reset();
        $('#categoryId').val('');
        $('#iconPreview').hide();
        $('#categoryModalLabel').text('Add New Category');
        $('.is-invalid').removeClass('is-invalid');
        $('.invalid-feedback').text('');
        currentCategoryId = null;
    }
</script>
</body>
</html>